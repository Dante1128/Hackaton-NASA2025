<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Mundi 3D Interactivo con Puntos de Datos</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #sidebar {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 200px;
            background: white;
            overflow-y: auto;
            border-right: 1px solid #ccc;
            padding: 10px;
        }
        #country-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #country-list li {
            padding: 5px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        #country-list li:hover {
            background: #f0f0f0;
        }
        #country-list li.selected {
            background: #007bff;
            color: white;
        }
        #globeViz {
            position: absolute;
            left: 200px;
            right: 0;
            top: 0;
            bottom: 0;
        }
    </style>
    <script src="//cdn.jsdelivr.net/npm/globe.gl"></script>
</head>
<body>
    <div id="sidebar">
        <h3>Selecciona un País</h3>
        <ul id="country-list"></ul>
    </div>
    <div id="globeViz"></div>

    <script>
        let selectedCountry = null;
        const countryList = document.getElementById('country-list');
        let countriesData = [];
        let liMap = {};
        let pointsData = [];

        const updateColors = () => feat => feat.properties.ADMIN === selectedCountry ? 'red' : 'rgba(0, 0, 255, 0.1)';
        const updateAltitude = () => feat => feat.properties.ADMIN === selectedCountry ? 0.06 : 0.01;

        const world = Globe()(document.getElementById('globeViz'))
            .globeImageUrl('//unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
            .bumpImageUrl('//unpkg.com/three-globe/example/img/earth-topology.png')
            .backgroundImageUrl('//unpkg.com/three-globe/example/img/night-sky.png')
            .polygonSideColor(() => 'rgba(0, 100, 0, 0.15)')
            .polygonStrokeColor(() => '#111')
            .polygonLabel(({ properties: d }) => `
                <b>${d.ADMIN || d.name} (${d.ISO_A2 || d.iso_a2})</b>
            `)
            .onPolygonHover(hoverD => world
                .polygonAltitude(hoverD ? 0.08 : updateAltitude())
            )
            .onPolygonClick(({ properties: d }) => selectCountry(d.ADMIN || d.name))
            .polygonsTransitionDuration(0)
            .polygonCapCurvatureResolution(3)
            .pointColor(() => 'red')
            .pointAltitude(0)
            .pointRadius(0.05)
            .pointLabel(d => `
                <b>${d.name}</b><br>
                País: ${d.country.name}<br>
                Coordenadas: ${d.lat.toFixed(4)}, ${d.lng.toFixed(4)}<br>
                Sensor: ${d.sensorName}
            `)
            .onPointClick(d => {
                world.pointOfView({ lat: d.lat, lng: d.lng, altitude: 0.5 }, 1000);
                alert(`Detalles del punto:\nNombre: ${d.name}\nPaís: ${d.country.name}\nSensor: ${d.sensorName}`);
            })
            .pointsTransitionDuration(0);

        // Cargar GeoJSON de países
        fetch('https://raw.githubusercontent.com/martynafford/natural-earth-geojson/master/110m/cultural/ne_110m_admin_0_countries.geojson')
            .then(res => res.json())
            .then(data => {
                countriesData = data.features;
                world.polygonsData(countriesData)
                    .polygonCapColor(updateColors())
                    .polygonAltitude(updateAltitude());

                const countryNames = countriesData.map(f => f.properties.ADMIN || f.properties.name).sort();
                countryNames.forEach(name => {
                    const li = document.createElement('li');
                    li.textContent = name;
                    li.onclick = () => selectCountry(name);
                    countryList.appendChild(li);
                    liMap[name] = li;
                });
            })
            .catch(err => console.error('Error loading GeoJSON:', err));

        // Cargar datos desde coordenadas.json
        fetch('./coordenadas.json')
            .then(res => res.json())
            .then(jsonData => {
                const results = jsonData.results || [];
                pointsData = results.map(loc => ({
                    lat: loc.coordinates.latitude,
                    lng: loc.coordinates.longitude,
                    name: loc.name,
                    country: loc.country,
                    sensorName: loc.sensors[0]?.parameter.displayName || 'N/A'
                }));
                world.pointsData(pointsData);
                console.log(`Cargados ${pointsData.length} puntos de datos.`);
            })
            .catch(err => console.error('Error al cargar coordenadas.json:', err));

        function selectCountry(name) {
            selectedCountry = name;
            world
                .polygonCapColor(updateColors())
                .polygonAltitude(updateAltitude());

            Object.values(liMap).forEach(li => li.classList.remove('selected'));
            if (liMap[name]) liMap[name].classList.add('selected');

            const selectedFeat = countriesData.find(f => (f.properties.ADMIN || f.properties.name) === name);
            if (selectedFeat) {
                const centroid = getCentroid(selectedFeat.geometry);
                world.pointOfView({ lat: centroid.lat, lng: centroid.lng, altitude: 1.5 }, 1000);
            }
        }

        function getCentroid(geometry) {
            let lats = 0, lngs = 0, count = 0;
            const coords = geometry.type === 'Polygon' ? geometry.coordinates[0] : geometry.coordinates.flat(2);
            coords.forEach(([lng, lat]) => {
                lats += lat;
                lngs += lng;
                count++;
            });
            return { lat: lats / count, lng: lngs / count };
        }
    </script>
</body>
</html>